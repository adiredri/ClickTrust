<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Click Trust</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200&display=swap" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="styles/indexCustomer.css">
</head>
<body>

    <video autoplay loop muted plays-inline id="myVideo">
<source src="images/Digital.mp4" type="video/mp4">
    </video>
    <div class="top-section">
    <nav>
        <div class="nav-bar">
        <a href="Contact.html">Contact Us</a>
        <a href="About.html">About Us</a>
        <a href="AddProduct.html">Add Asset</a>
        <a href="History.html">Cart</a>
        <div class="profile-info">
            <div class="profile-name">
                <a href="Profile.html" style="text-decoration: none;" id="welcome-message">Welcome, <span id="customer-name"></span></a>
            </div>
        </div>   
        <div class="profile-pic">
            <img src="images/adir.JPG" alt="Profile">
        </div> 
    </div>
    </nav>

  </div>
    <div class="text-box">
    <p>
        <p class="title">Weclome To Click Trust</p>
        <img src="images/BlueLogo.png" alt="" style="width: 70%;">
        <p class="under-text">The largest digital asset trading market in the world!</p>
        <p class="under-text">Here you can buy and sell digital assets <br> in many categories</p>
        <h2>Join us to save your money</h2>
        </p>
    </div>
    
<!------------------------- Search ------------------------>

<div class="text-box" style="height: 700px;">
  <h1 style="font-size: 40px;">Search Digital Asset</h1><br>
  <div class="search-container" style="margin-left: 50px;">
    <div>
      <label for="DateTrans">Search by Date:</label>
      <input type="date" id="DateTrans" style="width: 180px;" oninput="filterAssets()">
    </div>
    <div>
      <label for="Name">Search by Name</label>
      <input type="text" id="Name" oninput="filterAssets()">
    </div>
    <div>
      <label for="Category">Search by Category</label>
      <input type="text" id="Category" oninput="filterAssets()">
    </div>
    <div class="price-slider" style="margin-right: 50px;">
      <label for="price">Max Price: <output for="price" id="price-value">250</output></label><br>
      <input type="range" id="price" name="price" min="0" max="5000" value="200" onclick="filterAssets()">
  </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID Asset</th>
        <th>Category</th>
        <th>Name</th>
        <th>Place</th>
        <th>Date</th>
        <th>Time</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Purchase</th>
      </tr>
    </thead>
    <tbody id="assetTableBody">
      <!-- Assets will be dynamically added here -->
    </tbody>
  </table>
</div>


<!--------------------- Footer ------------------------>

    <footer>
        <div class="social">
        <div class="social-media">
            <div class="social-buttons-frame">
                <p>Come and say hello:</p>
            <a href="https://www.facebook.com" target="_blank"><img src="images/facebook.png" alt=""></a>
            <a href="https://twitter.com" target="_blank"><img src="images/twitter.png" alt=""></a>
            </div>
          </div>
    </div>
        <div class="main-branch-text">
            <h2>International HQ</h2>
            </div>
            <div class="iframe">
                <div>
                <h2>Israel</h2>
            <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d34579.96791412882!2d34.63612204225829!3d31.795924773011166!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x1502d4d75a26e2bb%3A0x4d2b2210db3bf6d5!2sAshdod!5e0!3m2!1sen!2sil!4v1646466304384!5m2!1sen!2sil" width="400" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <div>
            <h2>New York</h2>
            <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3022.5796714050683!2d-74.01121168431196!3d40.70603657933528!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x89c25a1c8d1fcb7b%3A0xdce94ce6f243135!2sNew%20York%20Stock%20Exchange!5e0!3m2!1sen!2sus!4v1646382180613!5m2!1sen!2sus" width="400" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <div>
            <h2>San Francisco</h2>
            <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d157372.91674221583!2d-122.67082447374838!3d37.44239264403174!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x808580d16c1d7a19%3A0xfe986ebe77a05e99!2sSilicon%20Valley%2C%20CA%2C%20USA!5e0!3m2!1sen!2sil!4v1646465546680!5m2!1sen!2si" width="400" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </div>
      </footer>
  
<script>

/*   background video  */

window.addEventListener('DOMContentLoaded', function() {
    var video = document.getElementById('myVideo');
    video.addEventListener('loadeddata', function() {
      fadeInOnce(video); // Call the modified fade-in function
    }, false);
  });
  
  function fadeInOnce(element) {
    var op = 0.01; // Initial opacity
    var timer = setInterval(function() {
      if (op >= 1) {
        clearInterval(timer);
        element.removeEventListener('loadeddata', fadeInOnce); // Remove the event listener after fading in
      }
      element.style.opacity = op;
      op += op * 0.1; // Adjust the fade-in speed here
    }, 10); // Adjust the interval (in milliseconds) between opacity changes here
  }

/*  top section opacity    */

</script>

<script>
  // Retrieve the customer's first name from the URL query parameter
  const urlParams = new URLSearchParams(window.location.search);
  const firstname = urlParams.get('firstName');

  // Update the HTML content with the customer's first name
  const customerNameElement = document.getElementById('customer-name');
  customerNameElement.textContent = firstname;
</script>

<script> /* slide bar */
  const priceSlider = document.getElementById("price");
  const priceValue = document.getElementById("price-value");
  
  priceSlider.addEventListener("input", function() {
      priceValue.textContent = this.value / 2; // הצגת חצי הערך שנבחר
  });
  </script>
<script src="https://static.elfsight.com/platform/platform.js" data-use-service-core defer></script>
<div class="elfsight-app-9499548e-2fe2-4f40-910f-3ad318347df0" data-elfsight-app-lazy></div>

<!--------------------- DB ------------------------>

<script>

const firstName = sessionStorage.getItem('firstName');

// Object to store coin names by ID
const assetNames = {};

// Function to fetch coins from the backend and populate the table
async function fetchAssets() {
  try {
    const response = await fetch('/assets');
    const assets = await response.json();

    // Sort the coins by largest price to lowest
    assets.sort((a, b) => b.Price - a.Price);

    const assetTableBody = document.getElementById('assetTableBody');

    // Iterate over the coins and create table rows dynamically
    assets.forEach((asset) => {
      const row = document.createElement('tr');
      row.innerHTML = `
          <td>${asset.assetId}</td>
          <td>${asset.assetCategory}</td>
          <td>${asset.assetName}</td>
          <td>${asset.assetPlace}</td>
          <td>${asset.assetDate}</td>
          <td>${asset.assetTime}</td>
          <td>${asset.assetQuantity}</td>
          <td>${asset.assetPrice}</td>
          <td>
            <button class="buy-button">Buy</button>
          </td>
        `;

        assetTableBody.appendChild(row);

      // Store coin names by ID for reference in purchased coins table
    //  assetNames[coin._id] = coin.CoinName;
    });

  //  updateCoinAmounts(firstName);  // עדכון לקניה של נכסים חדשים
  console.log('Assets:', assets); // לבדוק את הנתונים שמגיעים מהשרת
  } catch (error) {
    console.error('Error fetching assets:', error);
  }
}

// Function to filter assets based on search criteria
function filterAssets() {
      const searchByDate = document.getElementById('DateTrans');
      const searchByName = document.getElementById('Name');
      const searchByCategory = document.getElementById('Category');
      const maxPrice = document.getElementById('price');
 
      const assets = Array.from(document.getElementById('assetTableBody').getElementsByTagName('tr'));

  assets.forEach((asset) => {
    const DateTrans = asset.children[1].innerText;
    const AssetName = asset.children[2].innerText;
    const Category = asset.children[3].innerText;
    const price = parseFloat(coin.children[4].innerText);

    asset.style.display = '';

    if (searchByDate.value && !DateTrans.toLowerCase().includes(searchByDate.value.toLowerCase())) {
      asset.style.display = 'none';
    }

    if (searchByName.value && !AssetName.toLowerCase().includes(searchByName.value.toLowerCase())) {
      asset.style.display = 'none';
    }   

    if (searchByCategory.value && !Category.toLowerCase().includes(searchByCategory.value.toLowerCase())) {
      asset.style.display = 'none';
    }

    if (maxPrice.value && price > parseFloat(maxPrice.value)) {
      asset.style.display = 'none';
    }

  });
}

// Fetch assets when the page loads
fetchAssets();


</script>






<!--
  
<script>

  // Function to perform the trade based on the selected action (buy/sell)
async function performTrade(button, coinId, action) {
  const input = action === 'buy' ? button.parentNode.querySelector('.buy-input') : button.parentNode.querySelector('.sell-input');
  const amount = parseFloat(input.value);

  if (!isNaN(amount) && amount > 0) {
    const price = parseFloat(document.getElementById(`${coinId}Price`).innerText);

    if (action === 'buy') {
      const balanceElement = document.getElementById('balance');
      const balance = parseFloat(balanceElement.innerText);
      const totalPrice = price * amount;

      if (totalPrice <= balance) {
        buyCoin(coinId, price, amount);
      } else {
        alert('Insufficient balance to perform the purchase.');
      }
    } else if (action === 'sell') {
      try {
        const response = await fetch('/getOwnedAmount', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            CoinName: assetNames[coinId],
            UserName: firstName
          }),
        });

        if (response.ok) {
          const data = await response.json();
          const ownedAmount = data.amount;

          if (amount <= ownedAmount) {
            sellCoin(coinId, price, amount);
          } else {
            alert('You do not own enough coins to sell.');
          }
        } else {
          throw new Error('Failed to retrieve owned amount.');
        }
      } catch (error) {
        console.error('Error retrieving owned amount:', error);
        alert('An error occurred while retrieving your owned amount. Please try again later.');
      }
    }

    // Clear the amount input field
    input.value = '';
  }
}

async function buyCoin(coinId, price, amount) {
  const totalPrice = price * amount;
  const username = firstName;

  if (confirm('Are you sure you want to buy?')) {
    const response = await fetch('/addTrade', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        CoinName: assetNames[coinId],
        Amount: amount,
        Value: totalPrice,
        UserName: username,
      }),
    });

    if (response.ok) {
      alert('Trade confirmed.');
      location.reload(); // Refresh the page
    } else {
      alert('Failed to perform the purchase.');
    }
  } else {
    // User canceled the trade
    alert('Trade canceled.');
  }
}

async function sellCoin(coinId, price, amount) {
  const totalPrice = price * amount;
  const username = firstName;

  if (confirm('Are you sure you want to sell?')) {
    const response = await fetch('/reduceTrade', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        CoinName: assetNames[coinId],
        Amount: amount,
        Value: totalPrice,
        UserName: username,
      }),
    });

    if (response.ok) {
      alert('Trade confirmed.');
      location.reload(); // Refresh the page
    } else {
      alert('Failed to perform the sale.');
    }
  } else {
    // User canceled the trade
    alert('Trade canceled.');
  }
}

// עדכון לקניה של נכסים חדשים
// Function to fetch amaounts of every coin the user has 
async function updateCoinAmounts(username) {
  try {
    const response = await fetch(`/user/coin-amounts?username=${username}`);
    const coinAmounts = await response.json();

    // Iterate over the coin amounts object
    for (const coinName in coinAmounts) {
      const coinAmount = coinAmounts[coinName];
      const coinId = Object.keys(assetNames).find(key => assetNames[key] === coinName);
      const amountCell = document.getElementById(`${coinId}Amount`);

      if (amountCell) {
        amountCell.textContent = coinAmount.toFixed(2);
      }
    }
  } catch (error) {
    console.error('Error updating coin amounts:', error);
  }
}
</script>



<script>
  // Make a request to the server and fetch the assets data
  fetch('/allAssets')
    .then(response => response.json())
    .then(data => {
      // Sort the assets by User Name in alphabetical order
      data.sort((a, b) => a.Email.localeCompare(b.Email));

      const assetTableBody = document.getElementById('assetTableBody');
      const searchByDate = document.getElementById('DateTrans');
      const searchByName = document.getElementById('Name');
      const searchByCategory = document.getElementById('Category');
      const maxPrice = document.getElementById('price');

      const formatNumber = (number) => {
        const formattedNumber = Number(number).toFixed(2);
        return formattedNumber.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      };

      const formatDate = (dateString) => {
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' };
        return new Date(dateString).toLocaleDateString('en-US', options);
      };

      const filterAssets = () => {
        const searchDate = searchByDate.value.toLowerCase();
        const searchName = searchByName.value.toLowerCase();
        const searchCategory = searchByCategory.value.toLowerCase();
        const searchPrice = maxPrice.value;

        const filteredAssets = data.filter(asset => {
        const assetDate = asset.Date.toLowerCase();
        const assetName = asset.NameDigitalAsset.toLowerCase();
        const assetCategory = asset.Category.toLowerCase();
        const assetPrice = asset.Price;

          return assetDate.includes(searchDate) &&
            assetName.includes(searchName) &&
            (!searchPrice || assetPrice <= searchPrice) &&
            assetCategory.includes(searchCategory);
        });

        renderAssets(filteredAssets);
      };

      const renderAssets = (assets) => {
        assetTableBody.innerHTML = '';
        assets.forEach(asset => {
          const row = document.createElement('tr');
          row.innerHTML = `
          <td>${asset.assetId}</td>
          <td>${asset.assetCategory}</td>
          <td>${asset.assetName}</td>
          <td>${asset.assetPlace}</td>
          <td>${formatDate(asset.assetDate)}</td>
          <td>${asset.assetTime}</td>
          <td>${formatNumber(asset.assetQuantity)}</td>
          <td>${formatNumber(asset.assetPrice)}</td>
          <td>
            <input class="buy-input" type="text">
            <button class="buy-button" onclick="performAsset(this, '${asset._id}', 'buy')">Buy</button>
          </td>
        `;
        assetTableBody.appendChild(row);
        });
      };

      searchByDate.addEventListener('input', filterAssets);
      searchByName.addEventListener('input', filterAssets);
      searchByCategory.addEventListener('input', filterAssets);
      maxPrice.addEventListener('input', filterAssets);

      renderAssets(data);
    })
    .catch(error => console.error('Error:', error));
</script>


-->


</body>
</html>